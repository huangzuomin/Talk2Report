# n8n 2.0+ AI Agent 节点迁移指南

## 📋 概述

本文档说明了将 n8n 工作流中的 AI Agent 节点从旧版本语法迁移到 n8n 2.0+ 兼容语法的详细更改。

---

## 🔍 核心架构变化

### 旧版本语法 (n8n < 2.0)

```json
{
  "type": "n8n-nodes-base.openAi",
  "typeVersion": 1.5,
  "parameters": {
    "resource": "text",
    "operation": "message",
    "model": { "value": "Qwen/Qwen2.5-7B-Instruct" },
    "messages": {
      "values": [
        { "role": "system", "content": "..." },
        { "role": "user", "content": "..." }
      ]
    },
    "options": {
      "temperature": 0.3,
      "maxTokens": 2000,
      "responseFormat": "json_object"
    }
  }
}
```

**问题：**
- ❌ 使用旧的 `n8n-nodes-base.openAi` 节点类型
- ❌ 直接在参数中配置所有内容
- ❌ 不符合 n8n 2.0+ LangChain 架构

---

### 新版本语法 (n8n 2.0+)

#### 1. AI Agent (Root Node)

```json
{
  "id": "extractor-agent-a7e3b2c1",
  "name": "Extractor Agent",
  "type": "@n8n/n8n-nodes-langchain.agent",
  "typeVersion": 1.9,
  "parameters": {
    "promptType": "define",
    "text": "={{ $json.answers }}",
    "options": {
      "systemMessage": "=你是一个专业的信息抽取专家..."
    }
  }
}
```

**关键变化：**
- ✅ 使用 `@n8n/n8n-nodes-langchain.agent` 类型
- ✅ `typeVersion: 1.9` (最新 AI Agent 版本)
- ✅ `promptType: "define"` - 定义提示类型
- ✅ `text` - 用户提示内容
- ✅ `options.systemMessage` - 系统消息

#### 2. OpenAI Chat Model (Sub-Node)

```json
{
  "id": "extractor-chat-model",
  "name": "OpenAI Chat Model",
  "type": "@n8n/n8n-nodes-langchain.openAi",
  "typeVersion": 1.5,
  "parameters": {
    "modelId": {
      "__rl": true,
      "mode": "list",
      "value": "Qwen/Qwen2.5-7B-Instruct"
    },
    "options": {
      "temperature": 0.3,
      "maxTokens": 2000
    }
  }
}
```

**关键变化：**
- ✅ 使用 `@n8n/n8n-nodes-langchain.openAi` 类型
- ✅ `modelId` 替代 `model`
- ✅ 只包含模型相关配置
- ✅ 独立的子节点，需要连接到 AI Agent

---

## 🔌 节点连接方式

### 旧版本

```
Set Variables → Extractor Agent (n8n-nodes-base.openAi)
```

### 新版本

```
Set Variables → Extractor Agent (@n8n/n8n-nodes-langchain.agent)
                              ↓
                        (chatModel 连接)
                              ↓
                    OpenAI Chat Model (@n8n/n8n-nodes-langchain.openAi)
```

### JSON 连接配置

```json
"connections": {
  "Extractor Agent": {
    "chatModel": [
      [
        {
          "node": "OpenAI Chat Model",
          "type": "main",
          "index": 0
        }
      ]
    ]
  }
}
```

**关键点：**
- 使用 `chatModel` 连接类型（而非 `main`）
- OpenAI Chat Model 是子节点，通过 `chatModel` 端口连接到 AI Agent

---

## 📊 完整节点对比

### Extractor Agent 对比

| 方面 | 旧版本 | 新版本 |
|------|--------|--------|
| **节点类型** | `n8n-nodes-base.openAi` | `@n8n/n8n-nodes-langchain.agent` |
| **typeVersion** | 1.5 | 1.9 |
| **架构** | 单一节点 | Root node + Sub-node |
| **prompt 配置** | `messages.values[]` | `text` + `options.systemMessage` |
| **模型配置** | 内嵌在 parameters 中 | 独立的 Chat Model 节点 |
| **输出字段** | `$json.message.content` | `$json.output` |
| **JSON 模式** | `responseFormat: "json_object"` | 在 systemMessage 中说明 |

### Writer Agent 对比

完全相同的架构变化，主要差异在于提示词内容和参数（temperature、maxTokens）。

---

## 📝 具体修改步骤

### 步骤 1: 修改 AI Agent 节点

**旧代码：**
```json
{
  "parameters": {
    "resource": "text",
    "operation": "message",
    "model": { "value": "Qwen/Qwen2.5-7B-Instruct" },
    "messages": {
      "values": [
        {
          "role": "system",
          "content": "=你是一个专业的信息抽取专家..."
        },
        {
          "role": "user",
          "content": "请开始抽取结构化信息"
        }
      ]
    },
    "options": {
      "temperature": 0.3,
      "maxTokens": 2000,
      "responseFormat": "json_object"
    }
  }
}
```

**新代码：**
```json
{
  "parameters": {
    "promptType": "define",
    "text": "=访谈回答：\n{{ JSON.stringify($json.answers) }}\n\n请开始抽取结构化信息",
    "options": {
      "systemMessage": "=你是一个专业的信息抽取专家。你的任务是...\n\n## 输出格式\n你必须严格按照以下 JSON Schema 输出，只输出 JSON，不要任何解释。"
    }
  }
}
```

### 步骤 2: 添加 OpenAI Chat Model 子节点

```json
{
  "id": "extractor-chat-model",
  "name": "OpenAI Chat Model",
  "type": "@n8n/n8n-nodes-langchain.openAi",
  "typeVersion": 1.5,
  "position": [1340, 200],
  "parameters": {
    "modelId": {
      "__rl": true,
      "mode": "list",
      "value": "Qwen/Qwen2.5-7B-Instruct"
    },
    "options": {
      "temperature": 0.3,
      "maxTokens": 2000
    }
  },
  "credentials": {
    "openAiApi": {
      "id": "ibUDkwXjaazaG4NH",
      "name": "硅基流动"
    }
  }
}
```

### 步骤 3: 更新连接配置

在 `connections` 中添加：

```json
"Extractor Agent": {
  "chatModel": [
    [
      {
        "node": "OpenAI Chat Model",
        "type": "main",
        "index": 0
      }
    ]
  ]
}
```

### 步骤 4: 更新输出处理

**旧代码：**
```json
{
  "value": "={{ JSON.parse($json.message.content) }}"
}
```

**新代码：**
```json
{
  "value": "={{ JSON.parse($json.output) }}"
}
```

---

## 🎯 关键差异总结

### 1. 节点类型变化

| 用途 | 旧类型 | 新类型 |
|------|--------|--------|
| AI Agent | `n8n-nodes-base.openAi` | `@n8n/n8n-nodes-langchain.agent` |
| Chat Model | (包含在 Agent 中) | `@n8n/n8n-nodes-langchain.openAi` |

### 2. 参数结构变化

| 配置项 | 旧位置 | 新位置 |
|--------|--------|--------|
| 系统消息 | `messages.values[0].content` | `options.systemMessage` |
| 用户消息 | `messages.values[1].content` | `text` |
| 模型名称 | `model.value` | `modelId.value` (子节点) |
| Temperature | `options.temperature` | `options.temperature` (子节点) |
| Max Tokens | `options.maxTokens` | `options.maxTokens` (子节点) |

### 3. 输出字段变化

| 字段 | 旧版本 | 新版本 |
|------|--------|--------|
| AI 输出 | `$json.message.content` | `$json.output` |
| 错误信息 | `$json.error` | `$json.error` (相同) |

---

## ⚠️ 注意事项

### 1. JSON 模式处理

**旧版本：**
```json
"options": {
  "responseFormat": "json_object"
}
```

**新版本：**
在 `systemMessage` 中明确说明：
```
你必须严格按照以下 JSON 格式输出，只输出 JSON，不要任何解释。
```

### 2. 凭证配置

凭证配置方式相同，但需要注意：
- ✅ 凭证 ID 保持不变
- ✅ 凭证名称保持不变
- ✅ 在 Chat Model 子节点中引用凭证

### 3. 版本兼容性

- n8n >= 2.0: 使用新语法
- n8n < 2.0: 使用旧语法
- 建议升级到 n8n 2.0+ 以获得最新功能

---

## 🚀 迁移检查清单

在导入新工作流之前，确认：

- [ ] AI Agent 节点类型为 `@n8n/n8n-nodes-langchain.agent`
- [ ] OpenAI Chat Model 节点类型为 `@n8n/n8n-nodes-langchain.openAi`
- [ ] Chat Model 通过 `chatModel` 连接到 AI Agent
- [ ] `typeVersion` 为 1.9 (AI Agent) 和 1.5 (Chat Model)
- [ ] 输出字段从 `$json.message.content` 改为 `$json.output`
- [ ] 系统消息移到 `options.systemMessage`
- [ ] 用户消息移到 `text` 字段
- [ ] 模型配置移到独立的 Chat Model 子节点
- [ ] 凭证配置正确
- [ ] 所有连接已正确设置

---

## 📚 参考资源

### 官方文档
- [AI Agent 节点文档](https://docs.n8n.io/integrations/builtin/cluster-nodes/root-nodes/n8n-nodes-langchain.agent/)
- [OpenAI Chat Model 节点文档](https://docs.n8n.io/integrations/builtin/cluster-nodes/sub-nodes/n8n-nodes-langchain.lmchatopenai/)
- [n8n 2.0 Breaking Changes](https://docs.n8n.io/releases/v2.0-breaking-changes/)

### 相关资源
- [Build Your First AI Agent](https://n8n.io/workflows/6270-build-your-first-ai-agent/)
- [AI Agent 集成指南](https://n8n.io/integrations/agent/)
- [AI Agentic Workflows 指南](https://blog.n8n.io/ai-agentic-workflows/)

### GitHub Issues
- [Issue #15944 - Unable to link nodes](https://github.com/n8n-io/n8n/issues/15944)
- [Issue #12961 - AI Agent issues in 1.76.1](https://github.com/n8n-io/n8n/issues/12961)

---

## 🔄 版本历史

| 版本 | 日期 | 变更 |
|------|------|------|
| 2.1 | 2025-12-28 | n8n 2.0+ 兼容版 - 使用 AI Agent 架构 |
| 2.0 | 2025-12-28 | 生产优化版 |
| 1.0 | 初始版本 | 基础版本 |

---

**文档生成时间**: 2025-12-28
**n8n 版本要求**: >= 2.0
**作者**: Claude (AI Assistant)
