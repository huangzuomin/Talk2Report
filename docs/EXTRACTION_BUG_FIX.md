# Bug ä¿®å¤ï¼šç»“æ„åŒ–æ•°æ®æå–å¤±è´¥

## ğŸ› é—®é¢˜æè¿°

**ç”¨æˆ·åé¦ˆ**ï¼šè™½ç„¶ç”¨æˆ·æä¾›äº†å¤§é‡é«˜è´¨é‡çš„"å¹²è´§"ç´ æï¼Œä½†ç³»ç»Ÿåœ¨ç»“æ„åŒ–æ•°æ®æå–ä¸Šå­˜åœ¨ä¸¥é‡æ»åã€‚

**å…·ä½“è¡¨ç°**ï¼š
- ç”¨æˆ·å›ç­”äº†è¯¦ç»†çš„é—®é¢˜ï¼ˆå¦‚"å¤–å–ç®—æ³•æŠ¥é“"ï¼‰
- å³ä¾§æ§½ä½é¢æ¿ï¼ˆMaterialDashboardï¼‰æ²¡æœ‰å®æ—¶æ›´æ–°
- æ‰€æœ‰æ§½ä½ä»æ˜¾ç¤º"æ­£åœ¨è¯¢é—®"
- é‡åŒ–è¯æ®ç­‰å…³é”®ä¿¡æ¯æœªåŒæ­¥

---

## ğŸ” æ ¹æœ¬åŸå› 

### å…³é”®Bugï¼šAPIè°ƒç”¨æœªå‘é€ç”¨æˆ·æ¶ˆæ¯

**é—®é¢˜ä»£ç **ï¼ˆ`useInterviewMachine.js:388-396`ï¼‰ï¼š

```javascript
const response = await fetch(`${API_BASE}/chat`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    model: 'deepseek-chat',
    messages: [
      { role: 'system', content: systemPrompt }
      // âŒ ç¼ºå°‘ user æ¶ˆæ¯ï¼
    ],
    temperature: 0.1
  })
});
```

**é—®é¢˜åˆ†æ**ï¼š
1. Agent B åªæ”¶åˆ°äº† system prompt
2. **ç”¨æˆ·çš„å›ç­”æ ¹æœ¬æ²¡æœ‰å‘é€ç»™ DeepSeek API**
3. AI æ— æ³•æå–ä»»ä½•ä¿¡æ¯ï¼Œå› ä¸ºæ²¡æœ‰è¾“å…¥æ•°æ®
4. è¿”å›ç©ºç»“æœï¼š`{updates: []}`

**æ—¶åºå›¾**ï¼š
```
ç”¨æˆ·è¾“å…¥ â†’ sendMessage()
           â†“
    extractFromUserMessage(userText, state)
           â†“
    æ„å»º system promptï¼ˆåŒ…å«ç”¨æˆ·æ–‡æœ¬ï¼‰
           â†“
    è°ƒç”¨ API
           â†“
    âŒ åªå‘é€ systemï¼Œæ²¡æœ‰å‘é€ user æ¶ˆæ¯
           â†“
    AI æ— æ³•çœ‹åˆ°ç”¨æˆ·å›ç­”
           â†“
    è¿”å› {updates: []}
           â†“
    å³ä¾§é¢æ¿ä¸æ›´æ–°
```

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1ï¼šå‘é€ç”¨æˆ·æ¶ˆæ¯

**æ–‡ä»¶**ï¼š`src/hooks/useInterviewMachine.js`

```javascript
const response = await fetch(`${API_BASE}/chat`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    model: 'deepseek-chat',
    messages: [
      { role: 'system', content: systemPrompt },
      { role: 'user', content: userMessage }  // âœ… ä¿®å¤ï¼šå‘é€ç”¨æˆ·æ¶ˆæ¯
    ],
    temperature: 0.1
  })
});
```

### ä¿®å¤2ï¼šä¼˜åŒ–æå– Prompt

**æ”¹è¿›ç‚¹**ï¼š
1. âœ… æ˜¾ç¤ºå½“å‰å·²å¡«å……çš„æ§½ä½ï¼ˆé¿å…é‡å¤ï¼‰
2. âœ… æ˜ç¡®æå–è§„åˆ™ï¼ˆç²¾å‡†åŒ¹é…ã€ç²¾ç®€æ€»ç»“ã€é‡åŒ–ä¼˜å…ˆï¼‰
3. âœ… å¤šä¸ªè¯¦ç»†ç¤ºä¾‹ï¼ˆfew-shot learningï¼‰
4. âœ… å¼ºè°ƒ JSON æ ¼å¼è¾“å‡º

**æ–° Prompt ç»“æ„**ï¼š

```
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ•°æ®æå–ä¸“å®¶ã€‚

# æ§½ä½åˆ—è¡¨
- achievement_1 (æ ¸å¿ƒæˆæœä¸€): ...
- achievement_2 (æ ¸å¿ƒæˆæœäºŒ): ...
- metrics_achievement (é‡åŒ–è¯æ®): ...

# å½“å‰å·²å¡«å……çš„æ§½ä½
achievement_1: å®Œæˆå¤–å–ç®—æ³•æŠ¥é“...

# æå–è§„åˆ™
1. ç²¾å‡†åŒ¹é…ï¼šåˆ¤æ–­ç”¨æˆ·å›ç­”å±äºå“ªä¸ªæ§½ä½
2. ç²¾ç®€æ€»ç»“ï¼šç”¨1-2å¥è¯æ€»ç»“æ ¸å¿ƒä¿¡æ¯
3. é‡åŒ–ä¼˜å…ˆï¼šä¼˜å…ˆæå–æ•°å­—ã€æŒ‡æ ‡
4. å¤šæ§½ä½æå–ï¼šä¸€ä¸ªå›ç­”å¯èƒ½åŒ…å«å¤šä¸ªæ§½ä½ä¿¡æ¯

# æå–ç¤ºä¾‹
[æä¾›4ä¸ªè¯¦ç»†ç¤ºä¾‹]

# ç”¨æˆ·å›ç­”
${userMessage}

è¯·ä¸¥æ ¼æŒ‰ç…§ä¸Šè¿°è§„åˆ™æå–ä¿¡æ¯å¹¶è¾“å‡º JSONã€‚
```

### ä¿®å¤3ï¼šæ·»åŠ è°ƒè¯•æ—¥å¿—

```javascript
console.log('[Extract] Sending request for:', userMessage.slice(0, 50) + '...');
// ...
console.log('[Extract] Success:', result.updates);
```

---

## ğŸ§ª æµ‹è¯•ç»“æœ

### æµ‹è¯•è„šæœ¬
`n8n_workflows/tests/test_extraction_fix.js`

### æµ‹è¯•æ¡ˆä¾‹

#### æµ‹è¯•1ï¼šå•ä¸ªæ§½ä½ï¼ˆæˆæœï¼‰
**è¾“å…¥**ï¼š
```
æˆ‘å®Œæˆäº†å¤–å–ç®—æ³•æŠ¥é“ï¼Œè¿™ä¸ªæŠ¥é“åœ¨ç¤¾äº¤åª’ä½“ä¸Šå¼•èµ·äº†å¾ˆå¤§åå“ï¼Œ
é˜…è¯»é‡è¶…è¿‡äº†100ä¸‡ã€‚
```

**è¾“å‡º**ï¼š
```json
{
  "updates": [
    {"key": "achievement_1", "value": "å®Œæˆå¤–å–ç®—æ³•æŠ¥é“ï¼Œåœ¨ç¤¾äº¤åª’ä½“ä¸Šå¼•èµ·å¾ˆå¤§åå“"},
    {"key": "metrics_achievement", "value": "æŠ¥é“é˜…è¯»é‡è¶…è¿‡100ä¸‡"}
  ]
}
```
âœ… **æˆåŠŸæå–2ä¸ªæ§½ä½**

#### æµ‹è¯•2ï¼šå¤šä¸ªæ§½ä½ï¼ˆæˆæœ+é‡åŒ–ï¼‰
**è¾“å…¥**ï¼š
```
æˆ‘ä»¬è¿˜ä¼˜åŒ–äº†å‰ç«¯æ€§èƒ½ï¼Œå°†åŠ è½½æ—¶é—´ä»3ç§’é™åˆ°äº†1ç§’ã€‚
ç”¨æˆ·æ»¡æ„åº¦æå‡äº†40%ã€‚
```

**è¾“å‡º**ï¼š
```json
{
  "updates": [
    {"key": "achievement_2", "value": "ä¼˜åŒ–å‰ç«¯æ€§èƒ½ï¼Œç¼©çŸ­åŠ è½½æ—¶é—´"},
    {"key": "metrics_achievement", "value": "åŠ è½½æ—¶é—´ä»3ç§’é™è‡³1ç§’ï¼Œç”¨æˆ·æ»¡æ„åº¦æå‡40%"}
  ]
}
```
âœ… **æˆåŠŸæå–2ä¸ªæ§½ä½**

#### æµ‹è¯•3ï¼šæŠ€æœ¯æ ˆ
**è¾“å…¥**ï¼š
```
ä¸»è¦ä½¿ç”¨çš„æŠ€æœ¯æ˜¯Reactã€Node.jså’ŒMongoDBã€‚
```

**è¾“å‡º**ï¼š
```json
{
  "updates": [
    {"key": "tech_stack", "value": "ä¸»è¦ä½¿ç”¨Reactã€Node.jså’ŒMongoDB"}
  ]
}
```
âœ… **æˆåŠŸæå–1ä¸ªæ§½ä½**

#### æµ‹è¯•4ï¼šæ— æ–°ä¿¡æ¯
**è¾“å…¥**ï¼š
```
å¥½çš„ï¼Œæ²¡é—®é¢˜ã€‚
```

**è¾“å‡º**ï¼š
```json
{
  "updates": []
}
```
âœ… **æ­£ç¡®è¯†åˆ«æ— æ–°ä¿¡æ¯**

### æµ‹è¯•æ€»ç»“

| æŒ‡æ ‡ | ç»“æœ |
|------|------|
| æµ‹è¯•æ¡ˆä¾‹ | 4 |
| é€šè¿‡ | 4 |
| å¤±è´¥ | 0 |
| æˆåŠŸç‡ | **100%** âœ… |

---

## ğŸ“Š ä¿®å¤æ•ˆæœå¯¹æ¯”

| åŠŸèƒ½ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| APIè°ƒç”¨ | âŒ åªå‘é€ system | âœ… å‘é€ system + user |
| ç”¨æˆ·è¾“å…¥ | âŒ ä¸¢å¤± | âœ… ä¼ é€’ç»™ AI |
| ä¿¡æ¯æå– | âŒ å®Œå…¨å¤±è´¥ | âœ… 100% æˆåŠŸ |
| æ§½ä½æ›´æ–° | âŒ ä¸æ›´æ–° | âœ… å®æ—¶æ›´æ–° |
| é‡åŒ–è¯æ® | âŒ ä¸¢å¤± | âœ… è‡ªåŠ¨æ•è· |
| ç”¨æˆ·ä½“éªŒ | ğŸ˜• å›°æƒ‘ | ğŸ˜Š æ»¡æ„ |

---

## ğŸ”„ å®Œæ•´æ•°æ®æµ

### ä¿®å¤å‰
```
ç”¨æˆ·å›ç­” â†’ sendMessage()
           â†“
    extractFromUserMessage(userText, state)
           â†“
    æ„å»ºåŒ…å«ç”¨æˆ·æ–‡æœ¬çš„ system prompt
           â†“
    API è°ƒç”¨
           â†“
    âŒ åªå‘é€ system prompt
           â†“
    DeepSeek: "æˆ‘æ²¡çœ‹åˆ°ç”¨æˆ·å›ç­”ï¼Œè¿”å›ç©ºç»“æœ"
           â†“
    {updates: []}
           â†“
    å³ä¾§é¢æ¿ä¸æ›´æ–°
```

### ä¿®å¤å
```
ç”¨æˆ·å›ç­” â†’ sendMessage()
           â†“
    extractFromUserMessage(userText, state)
           â†“
    æ„å»ºä¼˜åŒ–çš„ system prompt
           â†“
    API è°ƒç”¨
           â†“
    âœ… å‘é€ system + user æ¶ˆæ¯
           â†“
    DeepSeek: "æˆ‘çœ‹åˆ°ç”¨æˆ·å›ç­”äº†ï¼Œæå–ä¿¡æ¯"
           â†“
    {updates: [
      {key: "achievement_1", value: "..."},
      {key: "metrics_achievement", value: "..."}
    ]}
           â†“
    æ›´æ–° state.slots
           â†“
    å³ä¾§é¢æ¿å®æ—¶æ›´æ–° âœ…
```

---

## ğŸ’¡ å…³é”®å­¦ä¹ ç‚¹

### 1. API æ¶ˆæ¯ç»“æ„

**é”™è¯¯**ï¼š
```javascript
messages: [
  { role: 'system', content: `ç”¨æˆ·è¯´ï¼š${userText}` }
]
```

**æ­£ç¡®**ï¼š
```javascript
messages: [
  { role: 'system', content: 'ä½ æ˜¯æ•°æ®æå–ä¸“å®¶...' },
  { role: 'user', content: userText }
]
```

### 2. Few-Shot Learning

æä¾›å¤šä¸ªç¤ºä¾‹å¯ä»¥æ˜¾è‘—æé«˜æå–å‡†ç¡®åº¦ï¼š
- ç¤ºä¾‹1ï¼šå•ä¸ªæ§½ä½
- ç¤ºä¾‹2ï¼šå¤šä¸ªæ§½ä½
- ç¤ºä¾‹3ï¼šæ— æ–°ä¿¡æ¯
- ç¤ºä¾‹4ï¼šè·³è¿‡

### 3. è°ƒè¯•çš„é‡è¦æ€§

æ·»åŠ è¯¦ç»†æ—¥å¿—å¯ä»¥å¿«é€Ÿå®šä½é—®é¢˜ï¼š
```javascript
console.log('[Extract] Sending request for:', userMessage.slice(0, 50) + '...');
console.log('[Extract] Success:', result.updates);
```

---

## ğŸ¯ éªŒè¯æ­¥éª¤

### 1. è¿è¡Œæµ‹è¯•
```bash
node n8n_workflows/tests/test_extraction_fix.js
```

**é¢„æœŸè¾“å‡º**ï¼š
```
ğŸ“Š æµ‹è¯•æ€»ç»“:
   âœ… é€šè¿‡: 4/4
   âŒ å¤±è´¥: 0/4
   ğŸ“ˆ æˆåŠŸç‡: 100.0%

ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼æ§½ä½æå–åŠŸèƒ½æ­£å¸¸å·¥ä½œã€‚
```

### 2. æµè§ˆå™¨æµ‹è¯•

1. åˆ·æ–°é¡µé¢ (http://localhost:5173)
2. å¼€å§‹è®¿è°ˆ
3. å›ç­”åŒ…å«å…·ä½“æˆæœçš„é—®é¢˜

**é¢„æœŸè¡Œä¸º**ï¼š
- âœ… å›ç­”åç«‹å³æå–ä¿¡æ¯
- âœ… å³ä¾§æ§½ä½è‡ªåŠ¨å¡«å……
- âœ… æ˜¾ç¤ºå…·ä½“å†…å®¹ï¼ˆå¦‚"å¤–å–ç®—æ³•æŠ¥é“"ï¼‰
- âœ… é‡åŒ–è¯æ®åŒæ­¥æ›´æ–°

### 3. æ§åˆ¶å°éªŒè¯

æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š

```
[Extract] Sending request for: æˆ‘å®Œæˆäº†å¤–å–ç®—æ³•æŠ¥é“...
[Interview Machine] Extracted: {updates: [{key: "achievement_1", value: "..."}]}
[Interview Machine] Updating slot achievement_1: å®Œæˆå¤–å–ç®—æ³•æŠ¥é“...
```

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|---------|
| `src/hooks/useInterviewMachine.js:393-398` | âœ… ä¿®å¤ï¼šæ·»åŠ  user æ¶ˆæ¯ |
| `src/hooks/useInterviewMachine.js:355-419` | âœ… ä¼˜åŒ–ï¼šæ”¹è¿› prompt |
| `src/hooks/useInterviewMachine.js:388` | âœ… æ·»åŠ ï¼šè°ƒè¯•æ—¥å¿— |
| `n8n_workflows/tests/test_extraction_fix.js` | âœ… æ–°å¢ï¼šæµ‹è¯•è„šæœ¬ |

---

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

### çŸ­æœŸï¼ˆå·²å®Œæˆï¼‰

âœ… ä¿®å¤ API è°ƒç”¨ bug
âœ… ä¼˜åŒ–æå– prompt
âœ… æ·»åŠ è¯¦ç»†æµ‹è¯•
âœ… æ·»åŠ è°ƒè¯•æ—¥å¿—

### ä¸­æœŸï¼ˆå¯é€‰ï¼‰

1. **æå–å‡†ç¡®åº¦æå‡**
   - æ”¶é›†æ›´å¤šå¤±è´¥æ¡ˆä¾‹
   - ä¼˜åŒ– prompt çš„ç¤ºä¾‹
   - ä½¿ç”¨æ›´å¼ºçš„æ¨¡å‹ï¼ˆå¦‚ GPT-4ï¼‰

2. **æ€§èƒ½ä¼˜åŒ–**
   - å¹¶è¡Œæå–å¤šä¸ªæ§½ä½
   - ç¼“å­˜å¸¸è§å›ç­”çš„æå–ç»“æœ
   - é¢„æå–å¯èƒ½çš„æ§½ä½

3. **ç”¨æˆ·åé¦ˆ**
   - æ˜¾ç¤º"æ­£åœ¨æå–ä¿¡æ¯..."æç¤º
   - æå–æˆåŠŸåæ˜¾ç¤ºâœ“å›¾æ ‡
   - å…è®¸ç”¨æˆ·æ‰‹åŠ¨ç¼–è¾‘æ§½ä½

### é•¿æœŸï¼ˆè€ƒè™‘ä¸­ï¼‰

4. **æ™ºèƒ½æå–**
   - æ ¹æ®æ§½ä½é‡è¦æ€§è°ƒæ•´æå–ç­–ç•¥
   - è‡ªåŠ¨è¯†åˆ«å…³é”®ä¿¡æ¯ï¼ˆæ•°å­—ã€ä¸“æœ‰åè¯ï¼‰
   - è·¨æ§½ä½å…³è”æå–

5. **è´¨é‡è¯„ä¼°**
   - ç»™æå–ç»“æœæ‰“åˆ†
   - æ ‡è®°ä¸ç¡®å®šçš„æå–
   - æç¤ºç”¨æˆ·ç¡®è®¤

---

## ğŸ”§ æ•…éšœæ’æŸ¥

å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œè¯·æ£€æŸ¥ï¼š

1. **API è°ƒç”¨æ˜¯å¦æ­£ç¡®**
   ```javascript
   // ç¡®è®¤æœ‰ä¸¤æ¡æ¶ˆæ¯
   messages.length === 2
   messages[1].role === 'user'
   ```

2. **ç”¨æˆ·æ¶ˆæ¯æ˜¯å¦å‘é€**
   ```javascript
   // åœ¨æ§åˆ¶å°è¿è¡Œ
   console.log('[Extract] User message:', userMessage);
   ```

3. **API å“åº”æ˜¯å¦æ­£å¸¸**
   ```bash
   # æµ‹è¯• API
   curl -X POST http://localhost:3001/api/deepseek/chat \
     -H "Content-Type: application/json" \
     -d '{"model":"deepseek-chat","messages":[{"role":"user","content":"æµ‹è¯•"}]}'
   ```

---

**æœ€åæ›´æ–°**: 2026-01-03
**çŠ¶æ€**: âœ… å·²ä¿®å¤å¹¶æµ‹è¯•é€šè¿‡
**æµ‹è¯•æˆåŠŸç‡**: 100%
