# 本地测试"推进访谈失败"问题诊断

## 问题原因

**前端调用**: `/api/interview` (BFF 代理)  
**实际情况**: 本地开发时，Vite 只运行前端，**没有运行 Serverless Functions**

### 错误流程
```
浏览器 (localhost:5173)
  ↓
  调用 /api/interview
  ↓
  ❌ 404 Not Found (Vite 没有这个路由)
```

---

## 解决方案（3 个选项）

### 方案 1: 使用 Vercel CLI 本地开发（推荐）

Vercel CLI 会同时运行前端和 Serverless Functions。

```bash
# 1. 安装 Vercel CLI
npm install -g vercel

# 2. 创建 .env.local
cat > .env.local << 'EOF'
N8N_INTERVIEW_URL=https://n8n.neican.ai/webhook/interview/next_step
N8N_GENERATE_URL=https://n8n.neican.ai/webhook/generate
N8N_AUTH_TOKEN=your_token_here
EOF

# 3. 使用 Vercel 本地开发
vercel dev

# 4. 访问 http://localhost:3000
```

**优势**:
- ✅ 完整模拟生产环境
- ✅ Serverless Functions 正常工作
- ✅ 环境变量自动加载

---

### 方案 2: 直连 n8n（快速测试）

跳过 BFF 层，前端直接连接 n8n。

#### 步骤 1: 创建 `.env.local`

```bash
# .env.local
VITE_N8N_INTERVIEW_URL=https://n8n.neican.ai/webhook/interview/next_step
VITE_N8N_GENERATE_URL=https://n8n.neican.ai/webhook/generate
VITE_N8N_AUTH_TOKEN=your_token_here
```

#### 步骤 2: 修改 `src/api/client.js`

```javascript
const resolveEnv = (key, fallback = '') => {
  return (
    import.meta.env[key] ||
    import.meta.env[`VITE_${key}`] ||
    fallback
  );
};

// 本地开发时直连 n8n，生产环境使用 BFF
const GENERATE_ENDPOINT = resolveEnv('N8N_GENERATE_URL', '/api/generate');
const INTERVIEW_ENDPOINT = resolveEnv('N8N_INTERVIEW_URL', '/api/interview');
const AUTH_TOKEN = resolveEnv('N8N_AUTH_TOKEN', '');

console.log('API Config:', {
  generateEndpoint: GENERATE_ENDPOINT,
  interviewEndpoint: INTERVIEW_ENDPOINT,
  hasToken: !!AUTH_TOKEN
});
```

#### 步骤 3: 重启开发服务器

```bash
npm run dev
```

**优势**:
- ✅ 快速测试
- ✅ 无需额外工具

**劣势**:
- ⚠️ 需要 n8n 配置 CORS
- ⚠️ 暴露 n8n 地址和 Token

---

### 方案 3: 使用 Vite Proxy（中间方案）

配置 Vite 代理，将 `/api/*` 请求转发到 n8n。

#### 步骤 1: 修改 `vite.config.js`

```javascript
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig({
  plugins: [react()],
  server: {
    proxy: {
      '/api/interview': {
        target: 'https://n8n.neican.ai',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api\/interview/, '/webhook/interview/next_step'),
        configure: (proxy, options) => {
          proxy.on('proxyReq', (proxyReq, req, res) => {
            // 添加认证 Token
            proxyReq.setHeader('Authorization', 'Bearer YOUR_TOKEN_HERE');
          });
        }
      },
      '/api/generate': {
        target: 'https://n8n.neican.ai',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api\/generate/, '/webhook/generate'),
        configure: (proxy, options) => {
          proxy.on('proxyReq', (proxyReq, req, res) => {
            proxyReq.setHeader('Authorization', 'Bearer YOUR_TOKEN_HERE');
          });
        }
      }
    }
  }
});
```

#### 步骤 2: 重启开发服务器

```bash
npm run dev
```

**优势**:
- ✅ 前端代码无需修改
- ✅ 模拟 BFF 行为

**劣势**:
- ⚠️ Token 硬编码在配置文件中
- ⚠️ 需要小心不要提交到 Git

---

## 推荐方案对比

| 方案 | 适用场景 | 复杂度 | 安全性 |
|------|---------|--------|--------|
| **方案 1: Vercel CLI** | 完整测试 | 中 | ✅ 高 |
| **方案 2: 直连 n8n** | 快速验证 | 低 | ⚠️ 中 |
| **方案 3: Vite Proxy** | 日常开发 | 中 | ⚠️ 中 |

---

## 快速诊断命令

### 检查当前配置

```bash
# 检查环境变量文件
cat .env.local

# 检查 Vite 是否运行
netstat -ano | findstr :5173

# 检查 Vercel 是否运行
netstat -ano | findstr :3000
```

### 测试 API 连通性

```bash
# 测试 n8n 直连
curl -X POST https://n8n.neican.ai/webhook/interview/next_step \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{"session_id":"test","answers":{},"current_question":{"id":"Q1","text":"test"}}'

# 测试本地 BFF (需要 Vercel CLI)
curl -X POST http://localhost:3000/api/interview \
  -H "Content-Type: application/json" \
  -d '{"session_id":"test","answers":{},"current_question":{"id":"Q1","text":"test"}}'
```

---

## 我的建议

### 立即行动（方案 2）

1. 创建 `.env.local`:
```bash
VITE_N8N_INTERVIEW_URL=https://n8n.neican.ai/webhook/interview/next_step
VITE_N8N_GENERATE_URL=https://n8n.neican.ai/webhook/generate
VITE_N8N_AUTH_TOKEN=your_actual_token_here
```

2. 重启开发服务器:
```bash
npm run dev
```

3. 打开浏览器控制台，查看 "API Config" 日志，确认配置正确

### 长期方案（方案 1）

生产部署前，使用 Vercel CLI 完整测试：
```bash
vercel dev
```

---

## 常见错误和解决

### 错误 1: "访谈推进失败：404"

**原因**: 本地没有运行 Serverless Functions  
**解决**: 使用方案 1 或方案 2

### 错误 2: "N8N_INTERVIEW_URL not configured"

**原因**: 环境变量未加载  
**解决**: 
- 确认 `.env.local` 存在
- 确认变量名有 `VITE_` 前缀（Vite 要求）
- 重启开发服务器

### 错误 3: CORS 错误

**原因**: n8n 未配置 CORS  
**解决**: 
- 在 n8n Webhook 节点的 Response Headers 中添加:
  ```json
  {
    "Access-Control-Allow-Origin": "*",
    "Access-Control-Allow-Methods": "POST, OPTIONS",
    "Access-Control-Allow-Headers": "Content-Type, Authorization"
  }
  ```

### 错误 4: "访谈推进失败：401"

**原因**: Token 错误或未配置  
**解决**: 检查 `N8N_AUTH_TOKEN` 是否正确

---

## 调试技巧

### 1. 查看浏览器控制台

打开 F12，查看：
- Network 标签：查看请求 URL 和状态码
- Console 标签：查看 "API Config" 日志

### 2. 查看 Vercel CLI 日志

```bash
vercel dev --debug
```

### 3. 添加调试日志

在 `src/api/client.js` 中：
```javascript
export async function nextInterviewStep(payload) {
  console.log('Interview Request:', {
    endpoint: INTERVIEW_ENDPOINT,
    payload
  });
  
  const response = await fetch(INTERVIEW_ENDPOINT, {
    method: 'POST',
    headers: withAuthHeader({ 'Content-Type': 'application/json' }),
    body: JSON.stringify(payload),
  });
  
  console.log('Interview Response:', {
    status: response.status,
    ok: response.ok
  });
  
  // ...
}
```

---

**立即尝试方案 2，应该能解决问题！**
