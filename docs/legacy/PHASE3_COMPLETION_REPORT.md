# Phase 3 å®ŒæˆæŠ¥å‘Š: n8n å¤šæ™ºèƒ½ä½“å·¥ä½œæµè®¾è®¡

## ğŸ“Š é¡¹ç›®çŠ¶æ€: Phase 3 å®Œæˆ âœ…

**å®Œæˆæ—¥æœŸ**: 2025-01-03
**ç‰ˆæœ¬**: v2.0-Phase3

---

## ğŸ¯ Phase 3 ç›®æ ‡

è®¾è®¡å¹¶å®ç°åŸºäº n8n çš„å¤šæ™ºèƒ½ä½“å·¥ä½œæµï¼Œå®ç°ä»è®¿è°ˆåˆ°æŠ¥å‘Šç”Ÿæˆçš„å®Œæ•´è‡ªåŠ¨åŒ–æµç¨‹ã€‚

## âœ… å®Œæˆçš„å·¥ä½œ

### 1. æ¶æ„è®¾è®¡ âœ…

åˆ›å»ºäº†å®Œæ•´çš„ n8n å·¥ä½œæµæ¶æ„è®¾è®¡æ–‡æ¡£:

**æ–‡ä»¶**: `docs/N8N_WORKFLOW_ARCHITECTURE.md`

**å†…å®¹**:
- ğŸ¨ å¤šæ™ºèƒ½ä½“åä½œæ¶æ„å›¾
- ğŸ“‹ å·¥ä½œæµæ¸…å• (Interview + Generate)
- ğŸ¤– 4ä¸ª Agent è¯¦ç»†è®¾è®¡ (A/B/C/D)
- ğŸ”„ è´¨é‡é—­ç¯æœºåˆ¶è®¾è®¡
- ğŸ“ æ–‡ä»¶ç»“æ„è§„åˆ’
- ğŸ” å®‰å…¨å’Œæ€§èƒ½è€ƒè™‘

### 2. Agent A: Interviewer å·¥ä½œæµ âœ…

**æ–‡ä»¶**: `n8n_workflows/interview_workflow.json`

**åŠŸèƒ½**:
- âœ… Webhook è§¦å‘å™¨: `/webhook/interview/next-step`
- âœ… æ¥æ”¶ç”¨æˆ·å›ç­”å’Œå½“å‰çŠ¶æ€
- âœ… è°ƒç”¨ DeepSeek Reasoner API
- âœ… æµå¼è¿”å›æ€è€ƒè¿‡ç¨‹å’Œä¸‹ä¸€ä¸ªé—®é¢˜
- âœ… å®æ—¶æå–å’Œæ›´æ–°æ§½ä½çŠ¶æ€
- âœ… è®¡ç®—å®Œæˆåº¦ç™¾åˆ†æ¯”

**æµç¨‹**:
```
Webhook â†’ Extract Input â†’ Call DeepSeek â†’ Parse Response â†’ Return to Webhook
```

**ç‰¹æ€§**:
- ä½¿ç”¨ DeepSeek Reasoner å±•ç¤ºæ€è€ƒè¿‡ç¨‹
- è‡ªåŠ¨æå–å…³é”®ä¿¡æ¯å¹¶æ›´æ–°æ§½ä½
- æ™ºèƒ½åˆ¤æ–­è®¿è°ˆæ˜¯å¦ç»“æŸ
- æ”¯æŒå¤šè½®å¯¹è¯çŠ¶æ€ç®¡ç†

### 3. Agent B + C + D: Generate å·¥ä½œæµ âœ…

**æ–‡ä»¶**: `n8n_workflows/generate_workflow.json`

**åŠŸèƒ½**:
- âœ… Webhook è§¦å‘å™¨: `/webhook/generate`
- âœ… Agent B (Archivist): æå–ç»“æ„åŒ–æ•°æ®
- âœ… Agent C (Writers): å¹¶è¡Œç”Ÿæˆ3ä¸ªç‰ˆæœ¬
- âœ… Agent D (Critic): è´¨é‡éªŒè¯
- âœ… è´¨é‡é—­ç¯: è‡ªåŠ¨é‡å†™æœºåˆ¶ (æœ€å¤š3æ¬¡)

**æµç¨‹**:
```
Webhook â†’ Agent B (Extract) â†’ Agent C (3 Writers å¹¶è¡Œ)
  â†’ Merge â†’ Agent D (Validate) â†’ Score Check
    â”œâ”€ Score â‰¥ 80 â†’ Return Success
    â””â”€ Score < 80 â†’ Rewrite Loop (max 3x) â†’ Return
```

**ç‰¹æ€§**:
- **Agent B**: æ˜ å°„åˆ° YearEndSummary schema
- **Agent C**: å¹¶è¡Œç”Ÿæˆ brief/formal/social ä¸‰ä¸ªç‰ˆæœ¬
- **Agent D**: é€»è¾‘ä¸€è‡´æ€§éªŒè¯ï¼Œ0-100åˆ†è¯„åˆ†
- **è´¨é‡é—­ç¯**: ä½äº80åˆ†è‡ªåŠ¨é‡å†™

### 4. æµ‹è¯•è„šæœ¬ âœ…

**æ–‡ä»¶**: `n8n_workflows/tests/test_workflows.js`

**åŠŸèƒ½**:
- âœ… æµ‹è¯• Agent A (Interviewer)
- âœ… æµ‹è¯• Agent B+C+D (Generate)
- âœ… ç«¯åˆ°ç«¯æµ‹è¯•
- âœ… æ€§èƒ½æµ‹è¯•
- âœ… è¯¦ç»†çš„æµ‹è¯•æ—¥å¿—

**ä½¿ç”¨æ–¹æ³•**:
```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
node n8n_workflows/tests/test_workflows.js

# è¿è¡Œç‰¹å®šæµ‹è¯•
node n8n_workflows/tests/test_workflows.js agent-a
node n8n_workflows/tests/test_workflows.js generate
node n8n_workflows/tests/test_workflows.js e2e
node n8n_workflows/tests/test_workflows.js perf
```

**æµ‹è¯•è¦†ç›–**:
- API è°ƒç”¨æˆåŠŸæ€§
- å“åº”æ ¼å¼éªŒè¯
- æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
- æ€§èƒ½åŸºå‡†æµ‹è¯•

### 5. éƒ¨ç½²æŒ‡å— âœ…

**æ–‡ä»¶**: `docs/N8N_DEPLOYMENT_GUIDE.md`

**å†…å®¹**:
- âœ… å‰ç½®è¦æ±‚
- âœ… è¯¦ç»†éƒ¨ç½²æ­¥éª¤
- âœ… Docker Compose é…ç½®
- âœ… ç”Ÿäº§ç¯å¢ƒé…ç½®
- âœ… æ•…éšœæ’é™¤
- âœ… æˆæœ¬ä¼°ç®—

**å…³é”®ä¿¡æ¯**:
- DeepSeek API é…ç½®
- n8n Credential è®¾ç½®
- Webhook URL é…ç½®
- ç¯å¢ƒå˜é‡è®¾ç½®
- ç›‘æ§å’Œè°ƒè¯•

---

## ğŸ“ äº¤ä»˜æ–‡ä»¶

### æ–‡æ¡£
```
docs/
â”œâ”€â”€ N8N_WORKFLOW_ARCHITECTURE.md    # å·¥ä½œæµæ¶æ„è®¾è®¡
â””â”€â”€ N8N_DEPLOYMENT_GUIDE.md          # éƒ¨ç½²æŒ‡å—
```

### å·¥ä½œæµ
```
n8n_workflows/
â”œâ”€â”€ interview_workflow.json          # Agent A è®¿è°ˆå·¥ä½œæµ
â”œâ”€â”€ generate_workflow.json           # Agent B+C+D ç”Ÿæˆå·¥ä½œæµ
â””â”€â”€ tests/
    â””â”€â”€ test_workflows.js            # æµ‹è¯•è„šæœ¬
```

---

## ğŸ—ï¸ æŠ€æœ¯å®ç°

### å·¥ä½œæµç‰¹æ€§

1. **æ¨¡å—åŒ–è®¾è®¡**
   - æ¯ä¸ª Agent ç‹¬ç«‹å·¥ä½œæµ
   - å¯å•ç‹¬æµ‹è¯•å’Œè°ƒè¯•
   - æ˜“äºç»´æŠ¤å’Œæ‰©å±•

2. **å¹¶è¡Œå¤„ç†**
   - Agent C çš„3ä¸ª Writer å¹¶è¡Œæ‰§è¡Œ
   - ä½¿ç”¨ Split In Batches èŠ‚ç‚¹
   - æå‡æ€§èƒ½çº¦3å€

3. **è´¨é‡é—­ç¯**
   - è‡ªåŠ¨è¯„åˆ†æœºåˆ¶
   - æ™ºèƒ½é‡å†™å†³ç­–
   - æœ€å¤§è¿­ä»£é™åˆ¶ (é˜²æ­¢æ— é™å¾ªç¯)

4. **çŠ¶æ€ç®¡ç†**
   - æ§½ä½ (Slot) æœºåˆ¶
   - å®æ—¶å®Œæˆåº¦è®¡ç®—
   - çŠ¶æ€æŒä¹…åŒ–

### n8n èŠ‚ç‚¹ä½¿ç”¨

| èŠ‚ç‚¹ç±»å‹ | ç”¨é€” | æ•°é‡ |
|---------|------|------|
| Webhook | æ¥æ”¶ HTTP è¯·æ±‚ | 2 |
| HTTP Request | è°ƒç”¨ DeepSeek API | 5 |
| Code (JS) | æ•°æ®å¤„ç†å’Œé€»è¾‘ | 3 |
| Split In Batches | å¹¶è¡Œæ‰§è¡Œ | 1 |
| Aggregate | åˆå¹¶ç»“æœ | 1 |
| IF | æ¡ä»¶åˆ¤æ–­ | 2 |
| Set | æ•°æ®èµ‹å€¼ | 4 |
| Sticky Note | æ–‡æ¡£è¯´æ˜ | 6 |

### DeepSeek API ä½¿ç”¨

| Agent | æ¨¡å‹ | ç”¨é€” |
|-------|------|------|
| Agent A | deepseek-reasoner | è®¿è°ˆæé—® + æ€è€ƒè¿‡ç¨‹ |
| Agent B | deepseek-chat | æå–ç»“æ„åŒ–æ•°æ® |
| Agent C | deepseek-chat | ç”ŸæˆæŠ¥å‘Š (3x) |
| Agent D | deepseek-reasoner | è´¨é‡éªŒè¯ + æ€è€ƒ |

---

## ğŸ“Š æ€§èƒ½ä¼°ç®—

### å“åº”æ—¶é—´ (å•æ¬¡æŠ¥å‘Šç”Ÿæˆ)

| é˜¶æ®µ | è€—æ—¶ |
|------|------|
| Agent B (æå–) | ~3-5s |
| Agent C (3 Writer å¹¶è¡Œ) | ~10-15s |
| Agent D (éªŒè¯) | ~2-3s |
| é‡å†™å¾ªç¯ (å¦‚éœ€è¦) | ~15-20s |
| **æ€»è®¡ (æ— é‡å†™)** | **~15-23s** |
| **æ€»è®¡ (1æ¬¡é‡å†™)** | **~30-43s** |

### æˆæœ¬ä¼°ç®— (åŸºäº DeepSeek å®šä»·)

| é¡¹ç›® | Tokens | æˆæœ¬ (Â¥) |
|------|--------|---------|
| Agent A (10è½®è®¿è°ˆ) | ~5K | Â¥0.01 |
| Agent B (æå–) | ~2K | Â¥0.004 |
| Agent C (3ç‰ˆæœ¬) | ~6K | Â¥0.012 |
| Agent D (éªŒè¯) | ~1K | Â¥0.002 |
| é‡å†™ (1-2æ¬¡) | ~10K | Â¥0.02-0.04 |
| **æ¯ä»½æŠ¥å‘Š** | ~24K | **Â¥0.05-0.07** |

**æœˆåº¦æˆæœ¬** (1000ä»½æŠ¥å‘Š): Â¥50-70/æœˆ (~$7-10/æœˆ)

---

## âœ… å®Œæˆçš„æ£€æŸ¥æ¸…å•

### æ¶æ„è®¾è®¡
- [x] å¤šæ™ºèƒ½ä½“åä½œæ¶æ„å›¾
- [x] å·¥ä½œæµæ•°æ®æµè®¾è®¡
- [x] Agent èŒè´£åˆ’åˆ†
- [x] è´¨é‡é—­ç¯æœºåˆ¶
- [x] æ–‡ä»¶ç»“æ„è§„åˆ’

### Agent A (Interviewer)
- [x] Webhook è§¦å‘å™¨
- [x] DeepSeek Reasoner é›†æˆ
- [x] æ€è€ƒè¿‡ç¨‹æµå¼è¿”å›
- [x] æ§½ä½çŠ¶æ€ç®¡ç†
- [x] å®Œæˆåº¦è®¡ç®—

### Agent B (Archivist)
- [x] å¯¹è¯å†å²åˆ†æ
- [x] ç»“æ„åŒ–æ•°æ®æå–
- [x] YearEndSummary schema æ˜ å°„
- [x] æ•°æ®éªŒè¯

### Agent C (Writers)
- [x] å¹¶è¡Œæ‰§è¡Œ3ä¸ª Writer
- [x] Brief ç‰ˆæœ¬ç”Ÿæˆ
- [x] Formal ç‰ˆæœ¬ç”Ÿæˆ
- [x] Social ç‰ˆæœ¬ç”Ÿæˆ
- [x] ç”¨æˆ·åå¥½é€‚é…

### Agent D (Critic)
- [x] é€»è¾‘ä¸€è‡´æ€§éªŒè¯
- [x] è¯„åˆ†æœºåˆ¶ (0-100)
- [x] é‡å†™å»ºè®®ç”Ÿæˆ
- [x] è´¨é‡é—­ç¯è§¦å‘

### æµ‹è¯•å’Œéƒ¨ç½²
- [x] æµ‹è¯•è„šæœ¬ç¼–å†™
- [x] å•å…ƒæµ‹è¯• (Agent A)
- [x] å•å…ƒæµ‹è¯• (Agent B+C+D)
- [x] ç«¯åˆ°ç«¯æµ‹è¯•
- [x] æ€§èƒ½æµ‹è¯•
- [x] éƒ¨ç½²æ–‡æ¡£
- [x] æ•…éšœæ’é™¤æŒ‡å—

---

## ğŸ¯ ä¸ç°æœ‰ç³»ç»Ÿçš„é›†æˆ

### å‰ç«¯é›†æˆ

å‰ç«¯å·²æœ‰ä¸¤ç§å®ç°æ–¹å¼:

1. **ç›´æ¥è°ƒç”¨ DeepSeek API** (å½“å‰å®ç°)
   - æ–‡ä»¶: `src/lib/deepseek-client.js`
   - ç«¯ç‚¹: `/api/deepseek/*`
   - ä¼˜ç‚¹: ä½å»¶è¿Ÿï¼Œæ— é¢å¤–ä¾èµ–

2. **é€šè¿‡ n8n å·¥ä½œæµ** (Phase 3 æ–°å¢)
   - æ–‡ä»¶: `src/api/client.js`
   - ç«¯ç‚¹: `/webhook/interview`, `/webhook/generate`
   - ä¼˜ç‚¹: å¯è§†åŒ–ï¼Œæ˜“ç»´æŠ¤ï¼Œå¯æ‰©å±•

### åˆ‡æ¢æ–¹å¼

åœ¨ `src/App.jsx` ä¸­é€‰æ‹©ä½¿ç”¨å“ªç§æ–¹å¼:

```javascript
// æ–¹å¼1: ç›´æ¥ DeepSeek API
import { useInterview } from './hooks/useDeepSeek';

// æ–¹å¼2: n8n å·¥ä½œæµ
import { useInterviewMachine } from './hooks/useInterviewMachine';
```

---

## ğŸ“ ä¸‹ä¸€æ­¥ (Phase 4)

### å¾…å®Œæˆé¡¹ç›®

1. **ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²**
   - [ ] é…ç½® n8n ç”Ÿäº§å®ä¾‹
   - [ ] è®¾ç½®æ•°æ®åº“ (PostgreSQL)
   - [ ] é…ç½®é˜Ÿåˆ—æ¨¡å¼
   - [ ] è®¾ç½®ç›‘æ§å’Œå‘Šè­¦

2. **æ€§èƒ½ä¼˜åŒ–**
   - [ ] å®ç°ç»“æœç¼“å­˜
   - [ ] ä¼˜åŒ– Agent prompts
   - [ ] å‡å°‘é‡å†™æ¬¡æ•°
   - [ ] å¹¶å‘æ§åˆ¶

3. **è´¨é‡æå‡**
   - [ ] æ”¶é›†çœŸå®ç”¨æˆ·åé¦ˆ
   - [ ] è°ƒæ•´ Agent D è¯„åˆ†æ ‡å‡†
   - [ ] ä¼˜åŒ– Agent C ç”Ÿæˆè´¨é‡
   - [ ] æ”¹è¿› Agent B æå–å‡†ç¡®æ€§

4. **åŠŸèƒ½æ‰©å±•**
   - [ ] æ”¯æŒæ›´å¤šæŠ¥å‘Šæ ¼å¼
   - [ ] æ”¯æŒæŠ¥å‘Šå¯¼å‡º (PDF/Word)
   - [ ] æ”¯æŒå†å²è®°å½•ç®¡ç†
   - [ ] æ”¯æŒå¤šç”¨æˆ·

---

## ğŸ‰ æ€»ç»“

Phase 3 å·²æˆåŠŸå®Œæˆï¼æˆ‘ä»¬è®¾è®¡å¹¶å®ç°äº†:

1. âœ… **å®Œæ•´çš„ n8n å¤šæ™ºèƒ½ä½“å·¥ä½œæµæ¶æ„**
2. âœ… **Agent A (Interviewer)** - è‹æ ¼æ‹‰åº•å¼è®¿è°ˆ
3. âœ… **Agent B (Archivist)** - ç»“æ„åŒ–æ•°æ®æå–
4. âœ… **Agent C (Writers)** - å¹¶è¡Œç”Ÿæˆ3ä¸ªç‰ˆæœ¬
5. âœ… **Agent D (Critic)** - è´¨é‡éªŒè¯å’Œé—­ç¯
6. âœ… **è´¨é‡é—­ç¯æœºåˆ¶** - è‡ªåŠ¨é‡å†™ç›´åˆ°æ»¡è¶³æ ‡å‡†
7. âœ… **æµ‹è¯•è„šæœ¬** - å®Œæ•´çš„æµ‹è¯•è¦†ç›–
8. âœ… **éƒ¨ç½²æŒ‡å—** - è¯¦ç»†çš„éƒ¨ç½²æ–‡æ¡£

**å…³é”®æˆå°±**:
- ğŸš€ å¹¶è¡Œå¤„ç†æå‡æ€§èƒ½3å€
- ğŸ”„ æ™ºèƒ½è´¨é‡é—­ç¯ç¡®ä¿æŠ¥å‘Šè´¨é‡
- ğŸ“Š æˆæœ¬å¯æ§ (~Â¥0.05-0.07/æŠ¥å‘Š)
- ğŸ› ï¸ æ˜“äºç»´æŠ¤å’Œæ‰©å±• (å¯è§†åŒ–å·¥ä½œæµ)
- ğŸ“š å®Œå–„çš„æ–‡æ¡£å’Œæµ‹è¯•

**é¡¹ç›®æ€»è¿›åº¦**:
```
Phase 1 (æ ¸å¿ƒæ›¿æ¢): â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% âœ…
Phase 2 (Chat UI):   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% âœ…
Phase 3 (n8nå·¥ä½œæµ): â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% âœ…
Phase 4 (ç”Ÿäº§éƒ¨ç½²):  â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   0% â³

æ€»ä½“è¿›åº¦: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 75%
```

---

**æŠ¥å‘Šç‰ˆæœ¬**: 1.0
**æœ€åæ›´æ–°**: 2025-01-03
**ç»´æŠ¤è€…**: Claude Code Assistant
